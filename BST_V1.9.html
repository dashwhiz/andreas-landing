<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Vermögensbilanz & Rentenprognose</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#ffffff;
      --ink:#111827;
      --muted:#464b5a;

      --card:#ffffff;
      --border:rgba(17,24,39,.10);

      --softBlue:#def1ff;
      --softBlueBorder:#bfe6ff;

      --softGreen:#e9fbf2;
      --softGreenBorder:#bfead5;

      --softRed:#ffecec;
      --softRedBorder:#ffc9c9;

      --shadow:0 18px 45px rgba(17,24,39,.10);
      --radius:16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{ max-width:1240px; margin:0 auto; padding:26px 18px 48px; }
    h1{ margin:0 0 10px; font-size:22px; letter-spacing:.2px; }
    p.lead{ margin:0 0 18px; color:var(--muted); line-height:1.5; max-width:980px; }

    .topbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin: 10px 0 16px; }

    select{
      font: inherit;
      border-radius: 14px;
      border: 1px solid rgba(17,24,39,.14);
      background: #fff;
      color: var(--ink);
      padding: 12px 14px;
      outline: none;
      cursor:pointer;
      min-width: 220px;
      font-weight: 800;
    }

    .grid{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width: 980px){ .grid{ grid-template-columns:1.2fr .8fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
    }
    .callout{
      background:var(--softBlue);
      border:2px solid var(--softBlueBorder);
      border-radius: calc(var(--radius) + 6px);
      padding:16px;
      overflow: visible;
    }

    .sectionTitle{ margin:0 0 10px; font-size:15px; font-weight:900; }
    .subTitle{ margin:14px 0 10px; font-size:13px; color:var(--muted); font-weight:900; letter-spacing:.2px; }

    .twoCol{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width: 760px){ .twoCol{ grid-template-columns:1fr 1fr; } }

    .field{ display:grid; gap:6px; }
    .labelRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    label{ font-size:13px; color:var(--muted); line-height:1.2; }

    input{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(17,24,39,.14);
      background:#fff;
      color:var(--ink);
      outline:none;
      transition:border-color .12s ease, box-shadow .12s ease;
    }
    input:focus{
      border-color: rgba(59,130,246,.55);
      box-shadow: 0 0 0 4px rgba(59,130,246,.12);
    }
    input[disabled]{
      background: rgba(17,24,39,.04);
      color: rgba(17,24,39,.70);
      border-color: rgba(17,24,39,.10);
      cursor:not-allowed;
    }

    .info{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px; height:22px;
      border-radius:999px;
      border:1px solid rgba(17,24,39,.16);
      background:#fff;
      color: rgba(17,24,39,.70);
      font-weight:900;
      font-size:12px;
      cursor: help;
      flex:0 0 auto;
      margin-left:6px;
    }
    .tip{
      position:absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translate(-50%, -4px);
      width: min(460px, calc(100vw - 40px));
      max-height: 260px;
      overflow: auto;

      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(17,24,39,.12);
      background: #fff;
      color: rgba(13,15,22,.92);
      box-shadow: 0 18px 45px rgba(17,24,39,.16);

      font-size: 12px;
      line-height: 1.45;
      opacity: 0;
      pointer-events: none;
      transition: opacity .12s ease, transform .12s ease;
      z-index: 9999;
      overflow-wrap: anywhere;
      white-space: normal;
      font-weight: 400;
    }
    .info:hover .tip{ opacity:1; transform: translate(-50%, 0); }

    .tableWrap{
      border-radius: 14px;
      border: 1px solid rgba(17,24,39,.12);
      background:#fff;
      overflow: visible;
      position: relative;
      z-index: 1;
    }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
      background:#fff;

      overflow: visible;
      border: none;
      border-radius: 0;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color: var(--muted);
      padding: 10px 12px;
      background: rgba(13,15,22,.02);
      border-bottom: 1px solid rgba(17,24,39,.08);
      font-weight: 900;
      vertical-align: middle;
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(17,24,39,.06);
      vertical-align: middle;
    }
    tbody tr:last-child td{ border-bottom:none; }

    thead th:nth-child(1), tbody td:nth-child(1){ width:44%; }
    thead th:nth-child(2), tbody td:nth-child(2){ width:18%; }
    thead th:nth-child(3), tbody td:nth-child(3){ width:18%; }
    thead th:nth-child(4), tbody td:nth-child(4){ width:20%; }

    .rowTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight: 800;
      font-size: 13px;
      color: rgba(13,15,22,.88);
      width:100%;
    }

    tbody td input{
      display:block;
      width:100%;
      max-width:120px;
      margin:0 auto;
      text-align:center;
      padding:9px 10px;
      border-radius:14px;
    }

    tr.totalRow td{
      border-top: 2px solid rgba(17,24,39,.14);
      background: rgba(13,15,22,.01);
      font-weight: 900;
    }

    .resultsCol{ display:grid; gap:12px; }
    .block{
      border-radius: 16px;
      border: 2px solid rgba(17,24,39,.10);
      padding: 14px;
      box-shadow: var(--shadow);
      background:#fff;
    }
    .block.expect{
      background: var(--softGreen);
      border-color: var(--softGreenBorder);
    }
    .block.worst{
      background: var(--softRed);
      border-color: var(--softRedBorder);
    }
    .blockHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      font-weight: 900;
    }
    .blockHeader .title{ font-size: 16px; }

    .miniKpi{
      border-radius: 14px;
      border: 1px solid rgba(17,24,39,.12);
      background: rgba(255,255,255,.65);
      padding: 10px 12px;
      margin-top:10px;
    }
    .miniKpi .k{ font-size:12px; color:var(--muted); }
    .miniKpi .v{ margin-top:6px; font-size:22px; font-weight:900; }

    .miniField{
      margin-top:10px;
      display:grid;
      gap:6px;
    }
    .miniField input{
      border-radius: 12px;
      padding: 10px 12px;
      text-align:left;
    }

    .warn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px; height:18px;
      margin-left:8px;
      border-radius:999px;
      border:1px solid rgba(185,28,28,.35);
      background: rgba(185,28,28,.10);
      color:#b91c1c;
      font-weight:900;
      font-size:12px;
      cursor: help;
      position:relative;
      vertical-align: middle;
    }
    .warn .tip{
      position:absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translate(-50%, -4px);
      width: min(420px, calc(100vw - 40px));
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(17,24,39,.12);
      background: #fff;
      color: rgba(13,15,22,.92);
      box-shadow: 0 18px 45px rgba(17,24,39,.16);
      font-size: 12px;
      line-height: 1.45;
      opacity: 0;
      pointer-events: none;
      transition: opacity .12s ease, transform .12s ease;
      z-index: 9999;
      overflow-wrap:anywhere;
      font-weight: 400;
    }
    .warn:hover .tip{ opacity:1; transform: translate(-50%, 0); }

    .statusLine{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(17,24,39,.10);
      background: rgba(13,15,22,.031);
      color: rgba(13,15,22,.70);
      font-size:12px;
      line-height:1.45;
      display:none;
    }
    .bad{ color:#b91c1c; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Vermögensbilanz &amp; Rentenprognose</h1>
  <p class="lead">
    Mit wenigen Eckdaten das Big Picture erkennen. Dein heutiges Vermögen umfasst neben Geld und etwaigen Immobilien auch deine Arbeitskraft
    (zukünftige Sparaktivität) und deine Rentenansprüche. Die Stabilität deines Vermögens hängt vom Risiko dieser Bausteine ab.
    Dein Einkommen im Alter hängt von den Risikoprämien ab, die du auf Dein Vermögen verdienen wirst. Die Prognosen werden in heutigen Preisen
    und im Vergleich zu deinen heutigen Ausgaben ausgegeben.
  </p>

  <div class="topbar">
    <select id="profil">
      <option value="">Beispiel laden…</option>
      <option value="user">User</option>
      <option value="frida">Frida</option>
      <option value="jana">Jana</option>
      <option value="fred">Fred</option>
      <option value="karin">Karin</option>
      <option value="armin">Armin</option>
      <option value="benno">Benno</option>
      <option value="frank">Frank</option>
    </select>
  </div>

  <div class="grid">
    <!-- INPUTS -->
    <div class="card">
      <div class="sectionTitle">Eingaben</div>

      <div class="subTitle">Eckdaten</div>
      <div class="twoCol">
        <div class="field">
          <div class="labelRow">
            <label>Sicherer Zins (% p.a.)</label>
            <span class="info">i<span class="tip">Mit diesem Zinssatz werden sichere Zahlungen auf- bzw. abgezinst.</span></span>
          </div>
          <input id="rPct" type="text" inputmode="decimal" value="2,0">
        </div>

        <div class="field">
          <div class="labelRow">
            <label>Einkommensentwicklung (% p.a.)</label>
            <span class="info">i<span class="tip">Mit dieser Wachstumsrate verändert sich Dein Einkommen pro Jahr im langfristigen Durchschnitt.</span></span>
          </div>
          <input id="gPct" type="text" inputmode="decimal" value="2,0">
        </div>
      </div>

      <div class="twoCol">
        <div class="field">
          <div class="labelRow">
            <label>Alter aktuell</label>
            <span class="info">i<span class="tip">Dein heutiges Alter.</span></span>
          </div>
          <input id="ageNow" type="text" inputmode="numeric" value="45">
        </div>

        <div class="field">
          <div class="labelRow">
            <label>Alter Renteneintritt</label>
            <span class="info">i<span class="tip">In diesem Alter hörst Du mit dem Arbeiten auf.</span></span>
          </div>
          <input id="ageRet" type="text" inputmode="numeric" value="67">
        </div>
      </div>

      <div class="field">
        <div class="labelRow">
          <label>Lebenserwartung</label>
          <span class="info">i<span class="tip">Bis zu diesem Alter sollte Deine Auszahlung reichen. Am besten, Du planst hier einen Puffer von mindestens 5 Jahren ein.</span></span>
        </div>
        <input id="ageLife" type="text" inputmode="numeric" value="90">
      </div>

      <div class="twoCol">
        <div class="field">
          <div class="labelRow">
            <label>Aktuelles Nettoeinkommen (€/Monat)</label>
            <span class="info">i<span class="tip">Der Betrag, der dir nach Abzügen für Steuern und Sozialversicherung für Ausgaben und Spartätigkeit bleibt.</span></span>
          </div>
          <input id="income" type="text" inputmode="decimal" value="950">
        </div>

        <div class="field">
          <div class="labelRow">
            <label>Sparquote (%)</label>
            <span class="info">i<span class="tip">Anteil des Nettoeinkommens, der gespart (positiv) oder entspart (negativ) wird.</span></span>
          </div>
          <input id="sPct" type="text" inputmode="decimal" value="10,0">
        </div>
      </div>

      <div class="twoCol">
        <div class="field">
          <div class="labelRow">
            <label>Abgabensatz auf Renteneinkommen (in %)</label>
            <span class="info">i<span class="tip">Pauschaler Unterschied zwischen Brutto- und Nettoeinkommen in der Rente – also Summe aus Steuern und Kranken- und Pflegeversicherung.</span></span>
          </div>
          <input id="taxPct" type="text" inputmode="decimal" value="25,0">
        </div>

        <div class="field">
          <div class="labelRow">
            <label>Gesetzliche Rente (€/Monat)</label>
            <span class="info">i<span class="tip">Eingabewert: Rentenauszahlung gemäß letztem Rentenbescheid bei 1% Rentenanpassungsfaktor.</span></span>
          </div>
          <input id="pensionMonthly" type="text" inputmode="decimal" value="1.262">
        </div>
      </div>

      <div class="subTitle">Vermögensübersicht</div>
      <div class="callout">
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Position</th>
                <th>Betrag (000€)</th>
                <th>
                  RE (Skala)
                  <span class="info">i
                    <span class="tip">
                      Risikoeinheiten (RE)<br>
                      Risikoeinheiten beschreiben die Wertschwankungen einzelner Vermögenspositionen auf einer einheitlichen Skala.
                      Höhere RE bedeuten stärkere Wertschwankungen. Zur Orientierung: Weltaktienmarkt hat im langfristigen Schnitt 4 RE.<br><br>
                      Aus den gewichteten RE des Gesamtvermögens wird die Eintrittswahrscheinlichkeit des schlechten Szenarios abgeleitet.
                    </span>
                  </span>
                </th>
                <th>
                  RP (%)
                  <span class="info">i
                    <span class="tip">
                      Risikoprämie (RP)<br>
                      Die Risikoprämie ist die erwartete Mehrrendite gegenüber dem sicheren Zins als Ausgleich für Risiko.<br><br>
                      Die gewichtete RP des Gesamtvermögens bestimmt gemeinsam mit dem sicheren Zins die erwartete Rendite
                      im Erwartungsszenario.
                    </span>
                  </span>
                </th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><div class="rowTitle"><span>Bankkonten</span><span class="info">i<span class="tip">Summe aller Kontostände bei Banken.</span></span></div></td>
                <td><input id="bankK" type="text" inputmode="decimal" value="50"></td>
                <td><input id="reBank" type="text" inputmode="decimal" value="0,0"></td>
                <td><input id="rpBankPct" type="text" inputmode="decimal" value="0,0"></td>
              </tr>

              <tr>
                <td><div class="rowTitle"><span>Altersvorsorge</span><span class="info">i<span class="tip">Aktueller Wert von privaten und betrieblichen Altersvorsorgeverträgen bzw. -zusagen.</span></span></div></td>
                <td><input id="pensionAssetK" type="text" inputmode="decimal" value="0"></td>
                <td><input id="rePensionAsset" type="text" inputmode="decimal" value="0,0"></td>
                <td><input id="rpPensionAssetPct" type="text" inputmode="decimal" value="0,0"></td>
              </tr>

              <tr>
                <td><div class="rowTitle"><span>Wertpapiere</span><span class="info">i<span class="tip">Summe aller Depotbestände.</span></span></div></td>
                <td><input id="secK" type="text" inputmode="decimal" value="220"></td>
                <td><input id="reSec" type="text" inputmode="decimal" value="3,5"></td>
                <td><input id="rpSecPct" type="text" inputmode="decimal" value="2,0"></td>
              </tr>

              <tr>
                <td><div class="rowTitle"><span>Immobilien</span><span class="info">i<span class="tip">Summe aller aktuellen Schätzwerte.</span></span></div></td>
                <td><input id="immoK" type="text" inputmode="decimal" value="300"></td>
                <td><input id="reImmo" type="text" inputmode="decimal" value="2,0"></td>
                <td><input id="rpImmoPct" type="text" inputmode="decimal" value="2,0"></td>
              </tr>

              <tr>
                <td><div class="rowTitle"><span>Kredite</span><span class="info">i<span class="tip">Summe aller Restschuld (bitte mit Minus-Zeichen eingeben).</span></span></div></td>
                <td><input id="debtK" type="text" inputmode="decimal" value="0"></td>
                <td><input id="reDebt" type="text" inputmode="decimal" value="0,0"></td>
                <td><input id="rpDebtPct" type="text" inputmode="decimal" value="0,0"></td>
              </tr>

              <tr>
                <td><div class="rowTitle"><span>Zukünftiges Sparen</span><span class="info">i<span class="tip">Gegenwartswert der zukünftigen Sparaktivitäten – wird automatisch berechnet. RE und RP können angepasst werden.</span></span></div></td>
                <td><input id="pvSaveK" type="text" value="0" disabled></td>
                <td><input id="rePvSave" type="text" inputmode="decimal" value="1,0"></td>
                <td><input id="rpPvSavePct" type="text" inputmode="decimal" value="0,0"></td>
              </tr>

              <tr>
                <td><div class="rowTitle"><span>Gesetzliche Rente</span><span class="info">i<span class="tip">Gegenwartswert bestehender und zukünftig erworbener Rentenansprüche – wird automatisch berechnet. RE und RP können angepasst werden.</span></span></div></td>
                <td><input id="pvPensK" type="text" value="0" disabled></td>
                <td><input id="rePvPens" type="text" inputmode="decimal" value="1,0"></td>
                <td><input id="rpPvPensPct" type="text" inputmode="decimal" value="1,0"></td>
              </tr>

              <tr class="totalRow">
                <td>Gesamtvermögen</td>
                <td><input id="sumTotalTodayTbl" type="text" disabled></td>
                <td><input id="sumReTodayTbl" type="text" disabled></td>
                <td><input id="sumRpWeightedTbl" type="text" disabled></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="statusLine" id="status"></div>
    </div>

    <!-- OUTPUTS -->
    <div class="resultsCol">
      <div class="block expect">
        <div class="blockHeader">
          <div class="title">
            Rentenprognose (mittleres Szenario)
            <span class="info">i
              <span class="tip">
                Mittleres Szenario<br>
                Dieses Szenario basiert auf der erwarteten Rendite des Gesamtvermögens
                (sicherer Zins + gewichtete Risikoprämie).<br><br>
                Es beschreibt den mittleren, langfristig erwarteten Verlauf ohne extreme Abweichungen.
              </span>
            </span>
          </div>
        </div>

        <div class="miniKpi">
          <div class="k">
            Rendite auf Vermögen (%)
            <span class="info">i
              <span class="tip">
                Erwartete jährliche Rendite des Gesamtvermögens im mittleren Szenario
                (sicherer Zins + gewichtete Risikoprämie).
              </span>
            </span>
          </div>
          <div class="v" id="outMuMid">—</div>
        </div>

        <div class="miniKpi">
          <div class="k">
            Monatsnetto
            <span class="info">i
              <span class="tip">
                Monatliches Netto-Einkommen in der Rente in heutigen Preisen.
                Berechnet aus dem prognostizierten Vermögen zum Renteneintritt und gleichmäßiger Auszahlung über die Rentenphase.
              </span>
            </span>
          </div>
          <div class="v" id="outNetMid">—</div>
        </div>

        <div class="miniKpi">
          <div class="k">
            Abdeckung heutiger Ausgaben
            <span class="info">i
              <span class="tip">
                Verhältnis von Renten-Monatsnetto zu heutigen monatlichen Ausgaben
                (heutiges Nettoeinkommen minus Sparbeitrag).<br><br>
                Beispiel: 60% bedeutet, dass ca. 60% der heutigen Ausgaben durch das Renten-Einkommen abgedeckt werden.
              </span>
            </span>
          </div>
          <div class="v" id="outNetMidPct">—</div>
        </div>
      </div>

      <div class="block worst">
        <div class="blockHeader">
          <div class="title">
            Rentenprognose (schlechtes Szenario)
            <span class="info">i
              <span class="tip">
                Schlechtes Szenario<br>
                Das schlechte Szenario beschreibt ein ungünstiges, aber realistisches Ergebnis.<br><br>
                Die Eintrittswahrscheinlichkeit wird aus erwarteter Rendite, Gesamtrisiko und Anlagehorizont berechnet.
                Die Rendite-Eingabe definiert die Schwelle, unterhalb derer das Ergebnis als „schlecht“ gilt.
              </span>
            </span>
          </div>
        </div>

        <div class="miniField">
          <div class="labelRow">
            <label>
              Rendite auf Vermögen (%)
              <span id="badMuWarn" class="warn" style="display:none;">
                !
                <span class="tip">Hinweis: Diese Rendite sollte unter der erwarteten Rendite liegen (Erwartung).</span>
              </span>
            </label>
            <span class="info">i
              <span class="tip">
                Schwellenrendite (schlechtes Szenario).<br>
                Die Eintrittswahrscheinlichkeit bezieht sich auf „Rendite ≤ Schwellenrendite“.
              </span>
            </span>
          </div>
          <input id="badMuPct" type="text" inputmode="decimal" value="0,00">
        </div>

        <div class="miniKpi">
          <div class="k">
            Eintrittswahrscheinlichkeit
            <span class="info">i
              <span class="tip">
                Wahrscheinlichkeit, dass die realisierte Rendite des Gesamtvermögens unter der definierten Schwellenrendite liegt.<br><br>
                Berechnung basiert auf einem stochastischen Renditemodell unter Berücksichtigung von Risiko und Anlagehorizont.
              </span>
            </span>
          </div>
          <div class="v" id="outProbBad">—</div>
        </div>

        <div class="miniKpi">
          <div class="k">
            Monatsnetto
            <span class="info">i
              <span class="tip">
                Monatliches Netto-Einkommen in der Rente, wenn sich das Vermögen bis zum Renteneintritt mit der angegebenen Schwellenrendite entwickelt.
              </span>
            </span>
          </div>
          <div class="v" id="outNetBad">—</div>
        </div>

        <div class="miniKpi">
          <div class="k">
            Abdeckung heutiger Ausgaben
            <span class="info">i
              <span class="tip">
                Verhältnis von Monatsnetto (schlechtes Szenario) zu heutigen monatlichen Ausgaben (heutiges Nettoeinkommen minus Sparbeitrag).
              </span>
            </span>
          </div>
          <div class="v" id="outNetBadPct">—</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (id) => document.getElementById(id);

  // Output formatting (German)
  const nfIntDE = new Intl.NumberFormat("de-DE", { maximumFractionDigits: 0 });
  const nf1DE   = new Intl.NumberFormat("de-DE", { minimumFractionDigits: 1, maximumFractionDigits: 1 });
  const nf2DE   = new Intl.NumberFormat("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const eur0DE  = new Intl.NumberFormat("de-DE", { style:"currency", currency:"EUR", maximumFractionDigits: 0 });

  const euro0  = (x) => isFinite(x) ? eur0DE.format(x) : "—";
  const int0   = (x) => isFinite(x) ? nfIntDE.format(Math.round(+x)) : "—";
  const oneDec = (x) => isFinite(x) ? nf1DE.format(+x) : "—";
  const twoDec = (x) => isFinite(x) ? nf2DE.format(+x) : "—";

  // Parse German numbers: "1.234,56", also tolerate "1234.56"
  function parseDE(s) {
    if (s == null) return NaN;
    let t = String(s).trim();
    if (!t) return NaN;

    t = t.replace(/\s+/g, "");

    if (t.includes(".") && t.includes(",")) {
      t = t.replace(/\./g, "").replace(",", ".");
      const v = Number(t);
      return isFinite(v) ? v : NaN;
    }
    if (t.includes(",")) {
      t = t.replace(/\./g, "");
      t = t.replace(",", ".");
      const v = Number(t);
      return isFinite(v) ? v : NaN;
    }

    const parts = t.split(".");
    if (parts.length === 2 && parts[1].length === 3 && parts[0].length >= 1) {
      t = parts[0] + parts[1];
    }
    const v = Number(t);
    return isFinite(v) ? v : NaN;
  }

  // Format helpers for INPUT display
  const fmtIntInp = new Intl.NumberFormat("de-DE", { maximumFractionDigits: 0 });
  const fmt1Inp   = new Intl.NumberFormat("de-DE", { minimumFractionDigits: 1, maximumFractionDigits: 1 });
  const fmt2Inp   = new Intl.NumberFormat("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  function formatIntField(id){
    const el = $(id);
    const v = parseDE(el.value);
    if (!isFinite(v)) return;
    el.value = String(Math.max(0, Math.round(v)));
  }
  function formatPct1Field(id){
    const el = $(id);
    const v = parseDE(el.value);
    if (!isFinite(v)) return;
    el.value = fmt1Inp.format(v);
  }
  function formatPct2Field(id){
    const el = $(id);
    const v = parseDE(el.value);
    if (!isFinite(v)) return;
    el.value = fmt2Inp.format(v);
  }
  function formatMoney0Field(id){
    const el = $(id);
    const v = parseDE(el.value);
    if (!isFinite(v)) return;
    el.value = fmtIntInp.format(Math.round(v));
  }

  // Standard normal CDF Φ(z)
  function erf(x) {
    const sign = x >= 0 ? 1 : -1;
    x = Math.abs(x);
    const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
    const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    const tt = 1 / (1 + p * x);
    const y = 1 - (((((a5 * tt + a4) * tt + a3) * tt + a2) * tt + a1) * tt) * Math.exp(-x * x);
    return sign * y;
  }
  function normSDist(z) {
    return 0.5 * (1 + erf(z / Math.SQRT2));
  }

  function pvFutureSavings000(x, nWork){
    const g_m = Math.pow(1 + x.g, 1/12) - 1;
    const d_m = Math.pow(1 + x.r + (x.rpPvSavePct/100), 1/12) - 1;

    if (Math.abs(d_m - g_m) < 1e-15) {
      return (x.income * x.s) * (nWork*12) / 1000;
    }
    return (x.income * x.s) *
      (1 - Math.pow((1+g_m)/(1+d_m), nWork*12)) /
      (d_m - g_m) / 1000;
  }

  function pvPension000(x, nWork, nRet){
    return x.pensionMonthly * (nRet*12) /
      Math.pow(1 + x.r + (x.rpPvPensPct/100), nWork) / 1000;
  }

  // Probability model (unchanged)
  function sigmaFromRE(re){
    const sig = Math.max(0, re) / 27;
    return Math.min(0.60, sig);
  }
  function probPoorScenarioNormal(mu, sigma, rf, tYears){
    const t = Math.max(1e-9, tYears);
    const sig = Math.max(0, sigma);
    if (sig < 1e-12){
      return (rf >= mu) ? 1 : 0;
    }
    const z = (rf - mu) / (sig / Math.sqrt(t));
    return normSDist(z);
  }

  // Defaults
  const USER_DEFAULTS = {
    // Rates
    r: 2.0,
    g: 2.0,

    // Demographics
    ageNow: 40,
    ageRet: 67,
    ageLife: 90,

    // Income & savings
    income: 2200,
    s: 8,
    tax: 20,
    pensionMonthly: 1262,

    // Assets (000 €)
    bankK: 15,
    pensionAssetK: 10,
    secK: 20,
    immoK: 0,
    debtK: 0,

    // Risk units (RE)
    reBank: 0,
    rePensionAsset: 1,
    reSec: 3,
    reImmo: 0,
    reDebt: 0,
    rePvSave: 2,
    rePvPens: 1,

    // Risk premia (RP %)
    rpBank: 0,
    rpPensionAsset: 1,
    rpSec: 3,
    rpImmo: 0,
    rpDebt: 0,
    rpPvSavePct: 2,
    rpPvPensPct: 1,

    // Worst-case threshold (%)
    rfBadPct: 0.0
  };


const EXAMPLES = {
  user: USER_DEFAULTS,

  frida: {
    ...USER_DEFAULTS,
    ageNow: 45,
    ageRet: 70,
    ageLife: 90,
    income: 950,
    pensionMonthly: 1262,
    s: -100,
    bankK: 50,
    pensionAssetK: 0,
    secK: 220,
    immoK: 300,
    debtK: 0,
    reSec: 3.5,
    reImmo: 2,

    // kalkulatorisch
    rePvSave: 0,
    rpPvSavePct: 0,
    rePvPens: 1,
    rpPvPensPct: 1
  },

  jana: {
    ...USER_DEFAULTS,
    g: 3,
    ageNow: 35,
    ageRet: 67,
    ageLife: 95,
    income: 2800,
    s: 10,
    tax: 20,
    pensionMonthly: 2200,
    bankK: 15,
    pensionAssetK: 25,
    secK: 20,
    immoK: 0,
    debtK: -10,
    rePensionAsset: 2,
    reSec: 4,

    // kalkulatorisch
    rePvSave: 1,
    rpPvSavePct: 4,
    rePvPens: 1,
    rpPvPensPct: 1
  },

  fred: {
    ...USER_DEFAULTS,
    ageNow: 50,
    ageRet: 70,
    ageLife: 90,
    income: 3800,
    s: 10,
    tax: 30,
    pensionMonthly: 1562,
    bankK: 90,
    pensionAssetK: 120,
    secK: 280,
    immoK: 800,
    debtK: -150,
    rePensionAsset: 2,
    reSec: 4,
    reImmo: 3,

    // kalkulatorisch
    rePvSave: 3,
    rpPvSavePct: 3,
    rePvPens: 1,
    rpPvPensPct: 1
  },

  karin: {
    ...USER_DEFAULTS,
    ageNow: 30,
    ageRet: 67,
    ageLife: 95,
    income: 1800,
    s: 5,
    tax: 20,
    pensionMonthly: 1908,
    bankK: 5,

    pensionAssetK: 0,
    secK: 0,
    immoK: 0,
    debtK: 0,

    // kalkulatorisch
    rePvSave: 1,
    rpPvSavePct: 2,
    rePvPens: 1,
    rpPvPensPct: 1
  },

  armin: {
    ...USER_DEFAULTS,
    ageNow: 40,
    income: 6400,
    s: 25,
    tax: 35,
    pensionMonthly: 3925,
    bankK: 125,
    pensionAssetK: 40,
    secK: 140,
    rePensionAsset: 2,
    reSec: 4,

    // kalkulatorisch
    rePvSave: 2,
    rpPvSavePct: 3.5,
    rePvPens: 1.5,
    rpPvPensPct: 1
  },

  benno: {
    ...USER_DEFAULTS,
    ageNow: 55,
    ageRet: 64,
    income: 58333.3333,
    s: 30,
    tax: 40,
    pensionMonthly: 3150,
    bankK: 200,
    pensionAssetK: 220,
    secK: 2500,
    immoK: 5500,
    debtK: -2000,
    reSec: 7,
    reImmo: 2.5,

    // kalkulatorisch
    rePvSave: 1,
    rpPvSavePct: 4,
    rePvPens: 1,
    rpPvPensPct: 1
  },

 frank: {
  ...USER_DEFAULTS,
  ageNow: 60,
  ageRet: 67,
  ageLife: 90,
  income: 6200,
  s: 12,
  tax: 35,
  pensionMonthly: 8309,

  // Assets — 
  bankK: 210,
  pensionAssetK: 0,
  secK: 0,
  immoK: 0,
  debtK: 0,

  // kalkulatorisch (from Excel)
  rePvSave: 0.5,
  rpPvSavePct: 0,
  rePvPens: 0.5,
  rpPvPensPct: 0.5,

  rfBadPct: 0
}
};

  function setDEInputsFromState(s){
    $("rPct").value = fmt1Inp.format(s.r);
    $("gPct").value = fmt1Inp.format(s.g);
    $("sPct").value = fmt1Inp.format(s.s);
    $("taxPct").value = fmt1Inp.format(s.tax);

    $("ageNow").value = String(s.ageNow);
    $("ageRet").value = String(s.ageRet);
    $("ageLife").value = String(s.ageLife);

    $("income").value = fmtIntInp.format(Math.round(s.income));
    $("pensionMonthly").value = fmtIntInp.format(Math.round(s.pensionMonthly));

    $("bankK").value = fmtIntInp.format(Math.round(s.bankK));
    $("pensionAssetK").value = fmtIntInp.format(Math.round(s.pensionAssetK));
    $("secK").value = fmtIntInp.format(Math.round(s.secK));
    $("immoK").value = fmtIntInp.format(Math.round(s.immoK));
    $("debtK").value = fmtIntInp.format(Math.round(s.debtK));

    $("reBank").value = fmt1Inp.format(s.reBank);
    $("rePensionAsset").value = fmt1Inp.format(s.rePensionAsset);
    $("reSec").value = fmt1Inp.format(s.reSec);
    $("reImmo").value = fmt1Inp.format(s.reImmo);
    $("reDebt").value = fmt1Inp.format(s.reDebt);
    $("rePvSave").value = fmt1Inp.format(s.rePvSave);
    $("rePvPens").value = fmt1Inp.format(s.rePvPens);

    $("rpBankPct").value = fmt1Inp.format(s.rpBank);
    $("rpPensionAssetPct").value = fmt1Inp.format(s.rpPensionAsset);
    $("rpSecPct").value = fmt1Inp.format(s.rpSec);
    $("rpImmoPct").value = fmt1Inp.format(s.rpImmo);
    $("rpDebtPct").value = fmt1Inp.format(s.rpDebt);
    $("rpPvSavePct").value = fmt1Inp.format(s.rpPvSavePct);
    $("rpPvPensPct").value = fmt1Inp.format(s.rpPvPensPct);

    $("badMuPct").value = fmt2Inp.format(s.rfBadPct ?? 0);
  }

  function readInputs(){
    return {
      r: parseDE($("rPct").value) / 100,
      g: parseDE($("gPct").value) / 100,
      ageNow: parseDE($("ageNow").value),
      ageRet: parseDE($("ageRet").value),
      ageLife: parseDE($("ageLife").value),

      income: parseDE($("income").value),
      s: parseDE($("sPct").value) / 100,
      tax: parseDE($("taxPct").value) / 100,
      pensionMonthly: parseDE($("pensionMonthly").value),

      rfBad: parseDE($("badMuPct").value) / 100,

      bankK: parseDE($("bankK").value),
      pensionAssetK: parseDE($("pensionAssetK").value),
      secK: parseDE($("secK").value),
      immoK: parseDE($("immoK").value),
      debtK: parseDE($("debtK").value),

      reBank: parseDE($("reBank").value),
      rePensionAsset: parseDE($("rePensionAsset").value),
      reSec: parseDE($("reSec").value),
      reImmo: parseDE($("reImmo").value),
      reDebt: parseDE($("reDebt").value),
      rePvSave: parseDE($("rePvSave").value),
      rePvPens: parseDE($("rePvPens").value),

      rpBankPct: parseDE($("rpBankPct").value),
      rpPensionAssetPct: parseDE($("rpPensionAssetPct").value),
      rpSecPct: parseDE($("rpSecPct").value),
      rpImmoPct: parseDE($("rpImmoPct").value),
      rpDebtPct: parseDE($("rpDebtPct").value),

      rpPvSavePct: parseDE($("rpPvSavePct").value),
      rpPvPensPct: parseDE($("rpPvPensPct").value)
    };
  }

  function showError(msg){
    const st = $("status");
    st.style.display = "block";
    st.innerHTML = `<span class="bad">${msg}</span>`;
  }
  function clearError(){
    const st = $("status");
    st.style.display = "none";
    st.textContent = "";
  }

  function recalc(){
    const x = readInputs();
    const nWork = x.ageRet - x.ageNow;
    const nRet  = x.ageLife - x.ageRet;

    const errors = [];
    if (!isFinite(nWork) || nWork <= 0) errors.push("Alter aktuell muss kleiner als Renteneintrittsalter sein.");
    if (!isFinite(nRet) || nRet <= 0) errors.push("Lebenserwartung muss größer als Renteneintrittsalter sein.");
    if (!isFinite(x.tax) || x.tax < 0 || x.tax > 1) errors.push("Abgabensatz prüfen (0–100%).");

    const numsToCheck = [
      x.r, x.g, x.income, x.s, x.pensionMonthly, x.rfBad,
      x.bankK, x.pensionAssetK, x.secK, x.immoK, x.debtK,
      x.reBank, x.rePensionAsset, x.reSec, x.reImmo, x.reDebt, x.rePvSave, x.rePvPens,
      x.rpBankPct, x.rpPensionAssetPct, x.rpSecPct, x.rpImmoPct, x.rpDebtPct, x.rpPvSavePct, x.rpPvPensPct
    ];
    if (numsToCheck.some(v => !isFinite(v))) errors.push("Bitte Eingaben prüfen (Zahlenformat).");

    if (errors.length){
      showError(errors.join(" "));
      return;
    }
    clearError();

    const pvSave000 = pvFutureSavings000(x, nWork);
    const pvPens000 = pvPension000(x, nWork, nRet);

    $("pvSaveK").value = int0(pvSave000);
    $("pvPensK").value = int0(pvPens000);

    const totalToday000 =
      x.bankK + x.pensionAssetK + x.secK + x.immoK + x.debtK + pvSave000 + pvPens000;

    const reToday = (totalToday000 !== 0) ? (
      (x.bankK * x.reBank) +
      (x.pensionAssetK * x.rePensionAsset) +
      (x.secK * x.reSec) +
      (x.immoK * x.reImmo) +
      (x.debtK * x.reDebt) +
      (pvSave000 * x.rePvSave) +
      (pvPens000 * x.rePvPens)
    ) / totalToday000 : 0;

    const rpWeightedDec = (totalToday000 !== 0) ? (
      (x.bankK * (x.rpBankPct/100)) +
      (x.pensionAssetK * (x.rpPensionAssetPct/100)) +
      (x.secK * (x.rpSecPct/100)) +
      (x.immoK * (x.rpImmoPct/100)) +
      (x.debtK * (x.rpDebtPct/100)) +
      (pvSave000 * (x.rpPvSavePct/100)) +
      (pvPens000 * (x.rpPvPensPct/100))
    ) / totalToday000 : 0;

    $("sumTotalTodayTbl").value = int0(totalToday000);
    $("sumReTodayTbl").value = oneDec(reToday);
    $("sumRpWeightedTbl").value = oneDec(rpWeightedDec * 100);

    const muMid = x.r + rpWeightedDec;

    const warn = $("badMuWarn");
    warn.style.display = (x.rfBad > muMid + 1e-12) ? "inline-flex" : "none";

    const wealthAtRetMid000 = totalToday000 * Math.pow(1 + muMid, nWork);
    const grossMidMonthly = 1000 * (wealthAtRetMid000 / (nRet*12));
    const netMid = ((1 - x.tax) * grossMidMonthly) / Math.pow(1 + x.r, nWork);

    const wealthAtRetBad000 = totalToday000 * Math.pow(1 + x.rfBad, nWork);
    const grossBadMonthly = 1000 * (wealthAtRetBad000 / (nRet*12));
    const netBad = ((1 - x.tax) * grossBadMonthly) / Math.pow(1 + x.r, nWork);

    const expensesToday = x.income * (1 - x.s);
    const coverMid = (expensesToday !== 0) ? (netMid / expensesToday) : NaN;
    const coverBad = (expensesToday !== 0) ? (netBad / expensesToday) : NaN;

    const sigma = sigmaFromRE(reToday);
    const pPoor = probPoorScenarioNormal(muMid, sigma, x.rfBad, nWork);

    $("outMuMid").textContent = twoDec(muMid * 100) + " %";
    $("outNetMid").textContent = euro0(netMid);
    $("outNetMidPct").textContent = isFinite(coverMid) ? int0(coverMid * 100) + " %" : "—";

    $("outProbBad").textContent = isFinite(pPoor) ? int0(pPoor * 100) + " %" : "—";
    $("outNetBad").textContent = euro0(netBad);
    $("outNetBadPct").textContent = isFinite(coverBad) ? int0(coverBad * 100) + " %" : "—";
  }

  const pct1Ids = ["rPct","gPct","sPct","taxPct","rpBankPct","rpPensionAssetPct","rpSecPct","rpImmoPct","rpDebtPct","rpPvSavePct","rpPvPensPct",
                   "reBank","rePensionAsset","reSec","reImmo","reDebt","rePvSave","rePvPens"];
  const pct2Ids = ["badMuPct"];
  const money0Ids = ["income","pensionMonthly","bankK","pensionAssetK","secK","immoK","debtK"];
  const intIds = ["ageNow","ageRet","ageLife"];

  pct1Ids.forEach(id => $(id).addEventListener("blur", () => formatPct1Field(id)));
  pct2Ids.forEach(id => $(id).addEventListener("blur", () => formatPct2Field(id)));
  money0Ids.forEach(id => $(id).addEventListener("blur", () => formatMoney0Field(id)));
  intIds.forEach(id => $(id).addEventListener("blur", () => formatIntField(id)));

  document.querySelectorAll("input, select").forEach(el => {
    el.addEventListener("input", () => {
      clearTimeout(window.__t);
      window.__t = setTimeout(recalc, 80);
    });
    el.addEventListener("change", () => {
      clearTimeout(window.__t);
      window.__t = setTimeout(recalc, 80);
    });
  });

  $("profil").addEventListener("change", (e) => {
    const key = e.target.value;
    if (!key) return;
    setDEInputsFromState(EXAMPLES[key] || USER_DEFAULTS);
    e.target.value = "";
    recalc();
  });

  setDEInputsFromState(USER_DEFAULTS);
  recalc();
</script>
</body>
</html>
